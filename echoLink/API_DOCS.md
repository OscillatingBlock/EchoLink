-----

# ðŸ“ž EchoLink API v3 (REST + TwiML)

EchoLink provides a RESTful interface for connecting Twilio accounts and managing AI phone agents powered by Gemini. The architecture relies entirely on TwiML and stateless webhooks.

-----

## ðŸ”‘ Base URL & Authentication

| Endpoint Type | Base URL | Auth Required |
| :--- | :--- | :--- |
| **User & Bot Management** | `https://api.echolink.studio/v1` | `Authorization: Bearer <JWT>` |
| **Twilio Webhooks** | `https://api.echolink.studio/v1` | **None** (Called by Twilio) |

-----

## I. User Management & Authentication

The **`ConnectTwilio`** endpoint serves as the primary registration and authentication mechanism.

### `POST /connect-twilio`

**Function:** Registers a new user account or updates an existing one, validates the Twilio credentials, and issues a **JWT** for subsequent API calls.
**Authentication:** **None** (Public endpoint)

| Parameter | Type | Required | Description |
| :--- | :--- | :--- | :--- |
| `first_name` | string | Yes | User's first name. |
| `last_name` | string | Yes | User's last name. |
| `email` | string | Yes | User's email (unique identifier). |
| `account_sid` | string | Yes | Twilio Account SID. |
| `auth_token` | string | Yes | Twilio Auth Token. |
| `phone_number_sid` | string | Yes | SID of the specific Twilio number to connect. |

**Success Response (200)**

```json
{
  "Message": "Connected",
  "PhoneNumber": "+18028022359",
  "AccessToken": "eyJhbGciOiJIUzI1NiI...[JWT_TOKEN]"
}
```

### `GET /my-number`

**Function:** Retrieves the user's connected phone number and the count of active bots.
**Authentication:** **JWT Required**

**Success Response (200)**

```json
{
  "PhoneNumber": "+18028022359",
  "BotsCount": 1
}
```

-----

## II. Bot Management (Protected Endpoints)

All endpoints in this section require the JWT issued by **`/connect-twilio`** in the `Authorization: Bearer` header.

### `POST /bots`

**Function:** Creates a new AI phone agent bot configuration.

| Parameter | Type | Required | Description |
| :--- | :--- | :--- | :--- |
| `goal` | string | Yes | The primary task/goal of the AI agent (e.g., "Book table"). |
| `webhook` | string | Yes | The URL the AI must call upon successful action completion. |
| `context` | string | No | Any additional, constant context or constraints for the AI (e.g., "Open 5-10PM"). |

**Success Response (201)**

```json
{
  "bot_id": "529552c5-ee7b-475f-a1b6-c7988a96d37c"
}
```

### `GET /bots`

**Function:** Lists all bots owned by the authenticated user.

**Success Response (200)**

```json
[
  {
    "bot_id": "529552c5-ee7b-475f-a1b6-c7988a96d37c",
    "goal": "Handle customer table bookings efficiently",
    "webhook": "https://restaurant-api.com/webhooks/bot-action",
    "created_at": "2025-10-31 02:30"
  }
]
```

### `DELETE /bots/:id`

**Function:** Deletes a specific bot configuration owned by the user.

| Path Parameter | Type | Description |
| :--- | :--- | :--- |
| `:id` | UUID | The Bot ID to delete. |

**Success Response (204)**: No content.

-----

## III. Twilio Webhook Endpoints (Call Flow)

These endpoints are called by Twilio and require no authentication.

### 1\. `POST /v1/voice` (Initial Call Webhook)

**Triggered By:** A customer calling the connected Twilio number.
**Function:** Initializes the conversation state, loads the bot configuration, and returns the opening TwiML prompt.

| Query Parameter | Description |
| :--- | :--- |
| `bot_id` | **Required.** The ID of the bot handling the call (set in the Twilio Console URL). |

**Success Response (200 - TwiML)**

```xml
<Response>
    <Say voice="man">Hi, how can I help you?</Say>
    <Gather input="speech" action="/v1/voice-response?bot_id=..." method="POST" speechTimeout="auto">
        <Say>Please speak now.</Say>
    </Gather>
    <Say>I didn't hear anything. Goodbye.</Say>
</Response>
```

### 2\. `POST /v1/voice-response` (Speech Result Webhook)

**Triggered By:** A customer speaking, after the `<Gather>` verb successfully transcribes the input.
**Function:** Retrieves the conversation history, calls the external ML service, updates the conversation state, and returns the next TwiML turn.

| Form Field | Description |
| :--- | :--- |
| `SpeechResult` | **Required.** The transcribed text from the user. |
| `CallSid` | Unique identifier for the call (for state tracking). |

**Success Response (200 - TwiML)**

Returns TwiML generated by the ML service response:

| Scenario | TwiML Result |
| :--- | :--- |
| **Conversation Continues** | `<Say> [AI Response] </Say><Gather action="/v1/voice-response?..." ...>` |
| **Conversation Ends** | `<Say> [Final Confirmation] </Say><Hangup/>` |

-----

## IV. Internal ML Microservice Contract

The Go ML Microservice running on **`http://localhost:5000`** must adhere to the following contract:

### `POST /ml/process`

**Request Body (JSON)**: Contains the current input and the full history (Context).

```json
{
  "bot_id": "...",
  "user_input": "I want to book a table for 4",
  "goal": "Book table",
  "context": "Initial Goal: Book table. Current history: User: I want to book a table for 4. Assistant: For what date...",
  "webhook": "https://api.eatery.com/book"
}
```

**Response Body (JSON)**: Contains the AI's dictated response and flow control flags.

```json
{
  "response": "Got it! Name and phone number please?",
  "action": "collect_info", 
  "webhook_data": null,
  "end_call": false 
}
```
